---
title: "Lichen Mapping"
author: "Rosemary Victoria Greensmith"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)


library(dplyr)
library(sf)
library(rnaturalearth)
library(httr)      # for getting data using API's
library(jsonlite)  # for getting NBN Atlas data

# kernel density map
library(sp) # for setting up the layers to map
library(adehabitatHR)
library(raster)

source("getNBNData.R")
source("occurrenceMap.R")
source("combinedMap.R")

library(showtext)
# library(ggtext)
# Fonts for plots
font_add_google("Montserrat", "mont")
font_add_google("Chivo", "chivo")
showtext_auto()
```


## Lichen Occurrences
### Lichen species names

```{r a, echo=FALSE, results='asis'}
# String of species names to loop through
# "Pseudevernia furfuracea" - need to add to nSensitive
nSensitive = c("Evernia prunastri","Usnea sp.",
               "Bryoria sp.","Sphaerophorus globosus","Hypogymnia sp.",
               "Parmelia sp.","Graphis sp.","Ochrolechia androgyna")
# "Punctelia subrudecta" - nTolerant
nTolerant = c("Xanthoria parietina","Xanthoria polycarpa","Xanthoria ucrainica",
              "Physcia adscendens","Physcia tenella",
              "Arthonia radiata","Lecidella elaeochroma","Amandinea punctata",
              "Candelariella reflexa")
indicatorSpp = cbind(nSensitive,nTolerant)
names(indicatorSpp) = c("N Sensitive", "N Tolerant")
indicatorSpp[length(nSensitive)+1,1] = "-"
knitr::kable(indicatorSpp, caption = "Nitrogen Indicator Species")
```

<!-- ### Base map -->

```{r,echo=FALSE}
# Download the base map of UK and surrounding countries
uk_map <- ne_countries(
  scale = "medium",
  returnclass = "sf"
) %>%
  filter(admin %in% c("United Kingdom", "Ireland",
                      "Jersey","France","Netherlands","Germany",
                      "Denmark","Belgium","Norway","Finland","Sweden"))

```


<!-- This code displays the raw NBN Atlas data on maps. -->

```{r occurrenceMaps, echo=FALSE}
################################################################################
#                 Maps of records from the NBN Atlas
################################################################################


# Set graphical parameters for the maps
op = par(mfrow=c(2,4), font.lab = 2,
         mar=c(2,2.5,1,0.1)+0.1,
         oma=c(0.01,0.01,2,0.01),xpd=FALSE)

###### Get NBN Atlas data and map the records ######
for (z in 1:2) {
  if (z == 1){
    indicatorSpp = nSensitive
  } else {
    indicatorSpp = nTolerant
  }
  for (a in 1:length(indicatorSpp)) {
    df = getNBNData(indicatorSpp[a],100)
    
    if(z==1) {
      colGroup = "a"
      mainTitle = "Nitrogen-sensitive Lichen"
    } else {
      colGroup = "b"
      mainTitle = "Nitrogen-tolerant Lichen"
    }
  
    occurrenceMap(uk_map,df,indicatorSpp[a],colGroup,kdePlot = TRUE)
    
     mtext(mainTitle,
          side = 3, line = -0.14, outer = TRUE,col = c("#131713"),
          font = 2,cex = 1.05)
    rm(df)
  }
  
}

```

## Combined Species occurrences

```{r combinedData, echo=FALSE}

for (z in 1:2) {
  if (z == 1){
    indicatorSpp = nSensitive
    indSppType = "nSensitive"
  } else {
    indicatorSpp = nTolerant
    indSppType = "nTolerant"
  }
  
  numRecords = 1e4

  for (a in 1:length(indicatorSpp)) {
    if (z == 1 && a == 1) {
      df = getNBNData(indicatorSpp[a],numRecords)
      df2 = data.frame(df$scientificName,
                       df$decimalLongitude,
                       df$decimalLatitude,
                       rep(indSppType, times = length(df[,1]))
                     )
    } else {
      df = getNBNData(indicatorSpp[a],numRecords)
      df2 = rbind(df2,data.frame(
        df$scientificName,
        df$decimalLongitude,
        df$decimalLatitude,
        rep(indSppType, times = length(df[,1]))
                     )
                  )
    }
  }
  df2 = na.omit(df2)
}
colnames(df2) = c("scientificName", "decimalLongitude", "decimalLatitude", "indicatorType")

head(df2)
plot(df2$decimalLongitude,df2$decimalLatitude)

```


```{r combinedMap, echo=FALSE}



# Plot the maps

# op = par(mfrow=c(1,2), font.lab = 2,
#          mar=c(2,2.5,1,0.1)+0.1,
#          oma=c(0.01,0.01,2,0.01),xpd=FALSE)

combinedMap(uk_map,
            sppDF = subset(df2,
                           indicatorType == "nSensitive",
                           select = c("decimalLongitude","decimalLatitude"))
)
combinedMap(uk_map,
            sppDF = subset(df2,
                           indicatorType == "nTolerant",
                           select = c("decimalLongitude","decimalLatitude")),
            indicatorSensitive = FALSE
)

```

